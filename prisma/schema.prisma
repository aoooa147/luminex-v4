// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model PowerLicense {
  code     String @id
  name     String
  priceWLD Float
  totalAPY Int

  @@map("power_licenses")
}

model UserPower {
  userId     String   @id @db.VarChar(42)
  code       String
  txId       String   @db.VarChar(66)
  reference  String   @unique
  acquiredAt DateTime @default(now())
  isPaid     Boolean  @default(true) // true = paid purchase, false = free/promotional

  @@map("user_powers")
}

model PowerDraft {
  reference  String   @id
  userId     String   @db.VarChar(42)
  targetCode String
  amountWLD  String
  createdAt  DateTime @default(now())
  status     String   @default("pending") // pending, used, cancelled

  @@index([userId])
  @@index([status])
  @@map("power_drafts")
}

model GameAction {
  id         String   @id @default(cuid())
  userId     String   @db.VarChar(42)
  gameId     String
  action     String
  data       Json?
  timestamp  DateTime @default(now())
  suspicious Boolean  @default(false)
  reason     String?
  confidence Float?
  deviceId   String? // Device fingerprint
  ipAddress  String? // IP address
  userAgent  String? // User agent string

  createdAt DateTime @default(now())

  @@index([userId, gameId, timestamp])
  @@index([userId])
  @@index([gameId])
  @@index([timestamp])
  @@index([suspicious])
  @@index([deviceId])
  @@index([ipAddress])
  @@map("game_actions")
}

model SuspiciousActivity {
  id         String    @id @default(cuid())
  userId     String    @db.VarChar(42)
  gameId     String?
  type       String // 'suspicious_score' | 'multiple_accounts' | 'vpn_detected' | 'bot_detected'
  severity   String    @default("medium") // 'low' | 'medium' | 'high'
  reason     String
  confidence Float
  data       Json?
  deviceId   String?
  ipAddress  String?
  blocked    Boolean   @default(false)
  resolved   Boolean   @default(false)
  resolvedAt DateTime?
  resolvedBy String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([type])
  @@index([severity])
  @@index([blocked])
  @@index([resolved])
  @@index([createdAt])
  @@map("suspicious_activities")
}

model DeviceFingerprint {
  id          String   @id @default(cuid())
  fingerprint String   @unique
  userIds     String[] // Array of user IDs using this device
  firstSeen   DateTime @default(now())
  lastSeen    DateTime @default(now())
  suspicious  Boolean  @default(false)
  blocked     Boolean  @default(false)
  metadata    Json? // Browser info, screen size, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fingerprint])
  @@index([suspicious])
  @@index([blocked])
  @@map("device_fingerprints")
}

model IPRecord {
  id           String    @id @default(cuid())
  ipAddress    String    @unique
  userIds      String[] // Array of user IDs using this IP
  country      String?
  isVPN        Boolean   @default(false)
  isProxy      Boolean   @default(false)
  isTor        Boolean   @default(false)
  riskLevel    String    @default("low") // 'low' | 'medium' | 'high'
  firstSeen    DateTime  @default(now())
  lastSeen     DateTime  @default(now())
  suspicious   Boolean   @default(false)
  blocked      Boolean   @default(false)
  blockedUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ipAddress])
  @@index([suspicious])
  @@index([blocked])
  @@index([riskLevel])
  @@map("ip_records")
}

model SystemSettings {
  id                String   @id @default("main")
  maintenanceMode   Boolean  @default(false)
  maintenanceMessage String? @db.Text
  broadcastMessage  String?  @db.Text
  broadcastEnabled  Boolean  @default(false)
  maxConcurrentUsers Int     @default(100000)
  systemVersion     String   @default("4.0.0")
  lastMaintenance   DateTime?
  updatedAt         DateTime @updatedAt
  updatedBy         String?  @db.VarChar(42)

  @@map("system_settings")
}
